pool:
  vmImage: 'ubuntu-18.04'

container: 'golang:latest'

variables:
  SRC_TF: "https://github.com/hashicorp/terraform"
  SRC_IBX: "https://github.com/infobloxopen/terraform-provider-infoblox"
  IBX_VER: "1.0.1"
  GO111MODULE: "on"

steps:
# build ibx provider
- script:
- bash: mkdir -p ${GOPATH}/src/github.com/infobloxopen
- bash: git clone ${SRC_IBX} ${GOPATH}/src/github.com/infobloxopen/terraform-provider-infoblox
- bash: ls -la ${GOPATH}/src/github.com/infobloxopen
- bash: cd ${GOPATH}/src/github.com/infobloxopen/terraform-provider-infoblox
- bash: ls -la ${GOPATH}/src/github.com/infobloxopen/terraform-provider-infoblox
#- bash: git clone ${SRC_IBX} /tmp/ibxsource
#- bash: cd /tmp/ibxsource
- bash: make build
#- bash: ls -la /tmp/ibxsource

- bash: mkdir /tmp/plugins
- bash: mv /tmp/ibxsource/terraform-provider-infoblox /tmp/plugins/terraform-provider-infoblox_v${IBX_VER}
# build terraform tools
- script:
- bash: git clone ${SRC_TF} /tmp/tfsource
- bash: cd /tmp/tfsource
- bash: go install ./tools/terraform-bundle
- bash: terraform-bundle package -plugin-dir /tmp/plugins /data/terraform-bundle.hcl
- bash: ARTIFACT=`ls ./terraform_*`
- bash: mv ${ARTIFACT} /tmp
